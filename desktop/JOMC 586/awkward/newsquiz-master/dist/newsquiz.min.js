/*! GDoc Powered Quiz - v0.1.0 - 2012-12-12
* https://github.com/motherjones/GDoc-Powered-Quiz
* Copyright (c) 2012 Ben Breedlove; Licensed MIT, GPL */
(function(e){e.quiz=function(t,n){var r;var i;var s=[];var o;var u={defaulting_behavior_on:true,defaulting_flag:"!default",container:"quiz_container",possible_display_elements:[{name:"backgroundimage",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<div class="'+this.name+'" style="background-image: url(\''+e[this.name]+"'); height: 100%; width: 100%;position:absolute;z-index: -1\"></div>")}},{name:"topimage",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<img src="'+e[this.name]+'" class="'+this.name+'"></img>')}},{name:"topvideoembed",finder:function(e){return e.find("."+this.name)},needs_aspect_ratio:true,create_element:function(e){if(!e.topvideoembedaspectratio){return""}return jQuery('<div class="videoembed '+this.name+'" style="padding-bottom:'+e.topvideoembedaspectratio+'%">'+e[this.name]+"</div>")}},{name:"title",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<h1 class="'+this.name+'">'+e[this.name]+"</h1>")}},{name:"middleimage",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<img src="'+e[this.name]+'" class="'+this.name+'"></img>')}},{name:"middlevideoembed",needs_aspect_ratio:true,finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e.middlevideoembedaspectratio){return""}return jQuery('<div class="videoembed '+this.name+'" style="padding-bottom:'+e.middlevideoembedaspectratio+'%">'+e[this.name]+"</div>")}},{name:"subhed",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<h2 class="'+this.name+'">'+e[this.name]+"</h2>")}},{name:"text",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<p class="'+this.name+'">'+e[this.name]+"</p>")}},{name:"bottomimage",finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e[this.name]){return""}return jQuery('<img src="'+e[this.name]+'" class="'+this.name+'"></img>')}},{name:"bottomvideoembed",needs_aspect_ratio:true,finder:function(e){return e.find("."+this.name)},create_element:function(e){if(!e.bottomvideoembedaspectratio){return""}return jQuery('<div class="videoembed '+this.name+'" style="padding-bottom:'+e.bottomvideoembedaspectratio+'%">'+e[this.name]+"</div>")}}],init:function(e,t){i=this;if(t){for(var n in t){i[n]=t[n]}}if(typeof e==="string"){i.make_quiz_from_google_spreadsheet(e);return i}i.calculate_aspectratios(e);i.quiz_data=e;i.create_cover();for(var r=0;r<i.quiz_data.length;r++){i.append_question(r)}i.append_how_you_did_section();return i},append_how_you_did_section:function(){o=jQuery('<span class="correct_answers">0</span>');var e=jQuery('<p class="how_you_did"></p>');e.append(jQuery("<span>You got </span>"));e.append(o);e.append(jQuery("<span> correct answers out of "+i.quiz_data.length+" questions</span>"));cover.append(e);cover.append(jQuery('<p class="small">on your first attempt. No fair changing your answers after you found out you were wrong</p>'))},make_quiz_from_google_spreadsheet:function(e){Tabletop.init({key:e,callback:function(e){var t=i.make_quiz_data_from_spreadsheet_data(e);i.init(t,n)},simpleSheet:true})},calculate_aspectratios:function(e){for(var t=0;t<e.length;t++){var n=e[t];for(var r=0;r<n.possible_answers.length;r++){var s=n.possible_answers[r];i.find_aspectratio_for_each_type_of_video_embed(s)}i.find_aspectratio_for_each_type_of_video_embed(n.question)}},find_aspectratio_for_each_type_of_video_embed:function(e){for(var t=0;t<i.possible_display_elements.length;t++){var n=i.possible_display_elements[t];if(n.needs_aspect_ratio&&e[n.name]){e[n.name+"aspectratio"]=i.find_aspectratio(e[n.name])}}},find_aspectratio:function(e){var t=e.match(/height="\d+"/);if(!t||!t[0]){console.log("Your video embed code needs a height.");return""}t=parseInt(t[0].replace(/height="/,"").replace(/"/,""));var n=e.match(/width="\d+"/);if(!n||!n[0]){console.log("Your video embed code needs a width.");return""}n=parseInt(n[0].replace(/width="/,"").replace(/"/,""));return t/n*100},pull_answer_value_from_spreadsheet:function(e,t,n,r){var r=r?"right":"wrong";if(e[r+n+t]&&e[r+n+t]!==i.defaulting_flag){return e[r+n+t]}if(i.defaulting_behavior_on&&e[r+n+t]!==i.defaulting_flag||!i.defaulting_behavior_on&&e[r+n+t]===i.defaulting_flag){return e[r+t]&&e[r+t]!==i.defaulting_flag?e[r+t]:e["answer"+t]&&e["answer"+t]!==i.defaulting_flag?e["answer"+t]:e["question"+t]}else{return""}},get_possible_answers:function(e,t){var n=[];var r=t?"right":"wrong";if(e[r]){n.push(i.make_possible_answer(e,"",t))}for(var s=0;s<10;s++){if(e[r+s]){n.push(i.make_possible_answer(e,s,t))}}return n},make_possible_answer:function(e,t,n){var r=n?"right":"wrong";var s={answer:e[r+t],correct:n};for(var o=0;o<i.possible_display_elements.length;o++){var u=i.possible_display_elements[o].name;s[u]=i.pull_answer_value_from_spreadsheet(e,u,t,n)}return s},make_quiz_data_from_spreadsheet_data:function(e){var t=[];for(var n=0;n<e.length;n++){var r=e[n];var s=i.get_possible_answers(r,false);var o=i.get_possible_answers(r,true);var u=[];for(var a=0;a<o.length;a++){u.push(Math.round(Math.random()*s.length))}u.sort();var f=[];var l=0;for(var a=0;a<=s.length;a++){while(a===u[l]){f.push(o[l]);l++}if(a===s.length){continue}f.push(s[a])}var c={question:{},possible_answers:f,rowNumber:r.rowNumber-1};for(var a=0;a<i.possible_display_elements.length;a++){var h=i.possible_display_elements[a].name;c.question[h]=r["question"+h]}t.push(c)}return t},append_question:function(e){var t=i.quiz_data[e];var n=jQuery('<li class="question_container row-fluid question_'+e+'"></li>');n.append(i.build_question_element_from_row(t));n.append(i.build_possible_answer_elements_from_row(t,e));r.append(n)},build_question_element_from_row:function(e){var t=jQuery('<div class="question col-12 show" style="overflow: hidden; position: relative;"></div>');for(var n=0;n<i.possible_display_elements.length;n++){t.append(i.possible_display_elements[n].create_element(e.question))}return t},build_possible_answer_elements_from_row:function(t,n){var r=jQuery('<ul class="col-12 possible_answers possible_answers_'+n+'"></ul>');for(var o=0;o<t.possible_answers.length;o++){var u=t.possible_answers[o];var a=jQuery('<li class="possible_answer col-12 answer_'+o+'">'+u.answer+"</li>");(function(t,n,o){o.bind("click",function(){var o=i.quiz_data[t].possible_answers[n].correct;r.find(".selected").removeClass("selected");e(this).addClass("selected");e(this).removeClass("possible_answer");r.find(".answer_"+n).addClass(o?"correct_answer":"wrong_answer");if(typeof s[t]==="undefined"){s[t]=o;i.update_correct_answers_element();cover.find(".question_"+t).addClass("first_guess_"+(o?"right":"wrong"))}i.display_answer(i.quiz_data[t],t,i.quiz_data[t].possible_answers[n]);i.quiz_data[t].previously_selected=i.quiz_data[t].possible_answers[n]})})(n,o,a);r.append(a)}return r},add_display_in_correct_place:function(e,t,n){for(var r=t;r>0;r--){if(i.possible_display_elements[r-1].finder(e).length){i.possible_display_elements[r-1].finder(e).after(i.possible_display_elements[t].create_element(n));return}}e.prepend(i.possible_display_elements[t].create_element(n))},display_answer:function(e,t,n){var s=e.previously_selected?e.previously_selected:e.question;var o=r.find(".question_"+t+" .question");o.addClass("revealed_answer");for(var u=0;u<i.possible_display_elements.length;u++){var a=i.possible_display_elements[u].name;if(n[a]!=s[a]){if(!n[a]){i.possible_display_elements[u].finder(o).remove()}else if(!s[a]){i.add_display_in_correct_place(o,u,n)}else{i.possible_display_elements[u].finder(o).before(i.possible_display_elements[u].create_element(n)).remove()}}}},create_cover:function(){cover=e("#"+i.container);r=jQuery("<ul></ul>");cover.append(r);r.addClass("quiz_container");r.css("padding","0px")},update_correct_answers_element:function(){var e=0;for(var t=0;t<i.quiz_data.length;t++){if(s[t]){e++}}o.text(e)}};return u.init(t,n)};e.fn.quiz=function(t,n){n=n||{};n.container=this.attr("id");this.quiz=e.quiz(t,n);return this}})(jQuery)